html
  head
    title Abootay
    meta(name='viewport', content='width=device-width, user-scalable=yes')
    meta(name='apple-mobile-web-app-capable', content='yes')
    meta(name='apple-mobile-web-app-status-bar-style', content='black-translucent')

    link(rel='stylesheet', type='text/css', href='/css/bootstrap.css')
    link(rel='stylesheet', type='text/css', href='/css/bootstrap-responsive.css')
    link(rel='stylesheet', type='text/css', href='/css/all.css', media='screen')

    script(src='/js/lib/underscore/underscore.js', type='text/javascript')
    script(src='/js/lib/underscore.string/underscore.string.js', type='text/javascript')
    script(src='/js/lib/jquery/jquery-1.7.1.js', type='text/javascript')
    script(src='/js/lib/async/async.js', type='text/javascript')
    script(src='/js/lib/backbone/backbone.js', type='text/javascript')
    script(src="/js/lib/jade/runtime.min.js", type="text/javascript")

  body
    #fb-root
    .container-fluid
      block body_content

      script(src='/js/main.js', type='text/javascript')
      script(src='/js/auth.js', type='text/javascript')
      
    if session.user
      script(src='/js/router.js', type='text/javascript')
      script(src='/js/models/Bucket.js', type='text/javascript')
      script(src='/js/models/BucketCollection.js', type='text/javascript')
      script(src='/js/models/User.js', type='text/javascript')
      script(src='/js/models/UserCollection.js', type='text/javascript')
      script(src="/js/renderers/buckets/buckets.js", type="text/javascript")
      script(src="/js/renderers/buckets/bucket.js", type="text/javascript")
      script(src="/js/renderers/home.js", type="text/javascript")
      script(src='/js/views/BucketView.js', type='text/javascript')
      script(src='/js/views/BucketCollectionView.js', type='text/javascript')
      script(src='/js/views/MainView.js', type='text/javascript')
      script
        MB.user = new MB.models.User({
          id: '#{session.user._id}'
        });
        MB.user.fetch({
          success: function() {
            console.log('User fetched');
            MB.user.get('buckets').fetch()
            new MB.Router();
            Backbone.history.start();
          }
        });
    script
      (function() {
        var callbacks = [];

        MB.facebook = function(callback) {
          if (FB) {
            callback();
            return;
          } else {
            callbacks.push(callback);
          }
        };
        window.fbAsyncInit = function() {
          FB.init({
            appId      : '#{config.facebook.appId}', // App ID
            channelUrl : '//www.abootay.com/channel.html', // Channel File
            status     : true, // check login status
            cookie     : true, // enable cookies to allow the server to access the session
            xfbml      : false  // parse XFBML
          });
          _.each(callbacks, function(callback) {
            callback();
          });
        };

        // Load the SDK Asynchronously
        (function(d){
           var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
           if (d.getElementById(id)) {return;}
           js = d.createElement('script'); js.id = id; js.async = true;
           js.src = "//connect.facebook.net/en_US/all.js";
           ref.parentNode.insertBefore(js, ref);
        })(document);
      })();